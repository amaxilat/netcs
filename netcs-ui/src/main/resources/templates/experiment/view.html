<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="'Experiment #'+${experimentId}">Experiment #</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'/>
    <!-- bootstrap 3.0.2 -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" type="text/css"/>
    <!-- font Awesome -->
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet" type="text/css"/>
    <!-- Ionicons -->
    <link th:href="@{/css/ionicons.min.css}" rel="stylesheet" type="text/css"/>
    <!-- Theme style -->
    <link th:href="@{/css/AdminLTE.css}" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body class="skin-blue">
<!-- header logo: style can be found in header.less -->
<header class="header">
    <a href="/" class="logo">
        <!-- Add the class icon to your logo image or logo icon to add the margining -->
        NETCS
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top" role="navigation">
        <!-- Sidebar toggle button-->
        <a href="#" class="navbar-btn sidebar-toggle" data-toggle="offcanvas" role="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>

        <div class="navbar-right">
            <ul class="nav navbar-nav">
                <!-- Messages: style can be found in dropdown.less-->
                <th:block th:include="user-status:: user-status"></th:block>
            </ul>
        </div>
    </nav>
</header>
<div class="wrapper row-offcanvas row-offcanvas-left">
    <!-- Left side column. contains the logo and sidebar -->
    <aside class="left-side sidebar-offcanvas">
        <!-- sidebar: style can be found in sidebar.less -->
        <th:block th:include="sidebar:: sidebar">

        </th:block>
        <!-- /.sidebar -->
    </aside>

    <!-- Right side column. Contains the navbar and content of the page -->
    <aside class="right-side">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                Experiment <span th:text="${experimentId}"></span>
            </h1>
            <ol class="breadcrumb">
                <li><a href="/experiment">Experiment</a></li>
                <li class="active" th:text="${title}">Blank page</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <graph-area class="col-md-6">

            </graph-area>
            <div class="col-md-6">
                <h3>Finished:<span th:text="${experiment.finished}"></span></h3>
                <th:block th:if="${experiment.finished}!=true">
                    <script>
                        setTimeout(function () {
                            location.reload();
                        }, 10000);
                    </script>

                </th:block>
                <h3>Stats:</h3>

                <div>Interactions:<span th:text="${experiment.experiment.interactions}"></span></div>
                <div>Eff. Interactions:<span th:text="${experiment.experiment.effectiveInteractions}"></span></div>

                <h3>Logs</h3>
                <pre th:text="${logs}">

                </pre>
            </div>
        </section>
        <!-- /.content -->
    </aside>
    <!-- /.right-side -->
</div>
<!-- ./wrapper -->
</body>

<!-- jQuery 2.0.2 -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
<!-- Bootstrap -->
<script th:src="@{/js/bootstrap.min.js}" type="text/javascript"></script>
<!-- AdminLTE App -->
<script th:src="@{/js/AdminLTE/app.js}" type="text/javascript"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></script>
<script type="text/javascript" src="http://bost.ocks.org/mike/fisheye/fisheye.js?0.0.3"></script>
<!--<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.6.0"></script>-->
<!--<script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js?2.6.0"></script>-->
<!--<script type="text/javascript" src="http://mbostock.github.com/d3/d3.geom.js?2.6.0"></script>-->

<script type="text/javascript" charset="utf-8" th:inline="javascript">
    /*<![CDATA[*/
    topologyNodes = /*[[${population.nodes}]]*/ {};
    topologyEdges = /*[[${edges}]]*/ {};
    /*]]>*/

    var w = 960, h = 500;

    var labelDistance = 0;

    var vis = d3.select("graph-area").append("svg:svg").attr("width", w).attr("height", h);

    var nodes = [];
    var labelAnchors = [];
    var labelAnchorLinks = [];
    var links = [];

    for (var i = 0; i != topologyNodes.length; i++) {
        var node = {
            label: topologyNodes[i].nodeName + ":" + topologyNodes[i].state,
            name: topologyNodes[i].nodeName
        };
        nodes.push(node);
        labelAnchors.push({
            node: node
        });
        labelAnchors.push({
            node: node
        });
    }
    ;

    function getNodeIndex(name) {
        for (var i = 0; i != nodes.length; i++) {
            if (nodes[i].name == name) {
                return i;
            }
        }
    }

    for (var i = 0; i != topologyEdges.length; i++) {
        thisEdge = topologyEdges[i];
        thisEdge = thisEdge.replace("(PopulationNode{", "").replace(" ", "").replace("})", "").replace("PopulationNode{", "").replace("}", "").replace(" ", "");
        startLabel = thisEdge.split(":")[0];
        endLabel = thisEdge.split(":")[2];
        startIndex = getNodeIndex(startLabel);
        endIndex = getNodeIndex(endLabel);
        console.log(startLabel + "(" + startIndex + ")" + "--" + "(" + endIndex + ")" + endLabel);
//        for (var j = 0; j != i; j++) {
//            if (Math.random() > .95)
        links.push({
            source: startIndex,
            target: endIndex,
            weight: 1
        });
//        }
        labelAnchorLinks.push({
            source: i * 2,
            target: i * 2 + 1,
            weight: 1
        });
    }
    ;

    var force = d3.layout.force().size([w, h]).nodes(nodes).links(links).gravity(1).linkDistance(50).charge(-3000).linkStrength(function (x) {
        return x.weight * 10
    });
    force.start();
    var force2 = d3.layout.force().nodes(labelAnchors).links(labelAnchorLinks).gravity(0).linkDistance(0).linkStrength(8).charge(-100).size([w, h]);
    force2.start();

    var link = vis.selectAll("line.link").data(links).enter().append("svg:line").attr("class", "link").style("stroke", "#CCC");

    var node = vis.selectAll("g.node").data(force.nodes()).enter().append("svg:g").attr("class", "node");
    node.append("svg:circle").attr("r", 5).style("fill", "#555").style("stroke", "#FFF").style("stroke-width", 3);
    node.call(force.drag);


    var anchorLink = vis.selectAll("line.anchorLink").data(labelAnchorLinks)//.enter().append("svg:line").attr("class", "anchorLink").style("stroke", "#999");

    var anchorNode = vis.selectAll("g.anchorNode").data(force2.nodes()).enter().append("svg:g").attr("class", "anchorNode");
    anchorNode.append("svg:circle").attr("r", 0).style("fill", "#FFF");
    anchorNode.append("svg:text").text(function (d, i) {
        return i % 2 == 0 ? "" : d.node.label
    }).style("fill", "#555").style("font-family", "Arial").style("font-size", 12);

    var updateLink = function () {
        this.attr("x1", function (d) {
            return d.source.x;
        }).attr("y1", function (d) {
            return d.source.y;
        }).attr("x2", function (d) {
            return d.target.x;
        }).attr("y2", function (d) {
            return d.target.y;
        });

    }

    var updateNode = function () {
        this.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

    }


    force.on("tick", function () {

        force2.start();

        node.call(updateNode);

        anchorNode.each(function (d, i) {
            if (i % 2 == 0) {
                d.x = d.node.x;
                d.y = d.node.y;
            } else {
                var b = this.childNodes[1].getBBox();

                var diffX = d.x - d.node.x;
                var diffY = d.y - d.node.y;

                var dist = Math.sqrt(diffX * diffX + diffY * diffY);

                var shiftX = b.width * (diffX - dist) / (dist * 2);
                shiftX = Math.max(-b.width, Math.min(0, shiftX));
                var shiftY = 5;
                this.childNodes[1].setAttribute("transform", "translate(" + shiftX + "," + shiftY + ")");
            }
        });


        anchorNode.call(updateNode);

        link.call(updateLink);
        anchorLink.call(updateLink);

    });

</script>
</html>